using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;
using System.Xml;
using System.Xml.Serialization;
using PenTester.Objects.Nessus;
using PenTester.Objects.Nmap;
using PenTester.Objects;
using System.Diagnostics;
using Roslyn.Scripting;
using Roslyn.Scripting.CSharp;
using Roslyn.Compilers.CSharp;
using System.IO;
using System.Text;
using System.Reflection;
using PenTester.Models;

namespace PenTester.Controllers
{
    public class HomeController : Controller
    {
        [AllowAnonymous]
        public ActionResult Test()
        {
            string dllLoc = @"C:\Users\Ethan\SkyDrive\Code13\PenTester\PenTester\Groups\2\Plugins\f5d068af-dfe2-4dd1-b289-4f5ce25b6201.dll";
            SyntaxTree tree = SyntaxTree.ParseFile(dllLoc.Replace(".dll", ".cs"));
            Assembly myAsm = Assembly.LoadFrom(dllLoc);
            object host = myAsm.CreateInstance(((ClassDeclarationSyntax)tree.GetRoot().Members.First(m => m is ClassDeclarationSyntax)).Identifier.ToString());
            XmlSerializer ser = new XmlSerializer(host.GetType());
            System.IO.FileStream file = System.IO.File.OpenRead(dllLoc.Replace(".dll", ".xml"));

            host = ser.Deserialize(file);
            DynamicHostList dhl = (DynamicHostList)host;
            ReportTemplate report = new ReportTemplate();
            report.AddReport(dhl);

            return View(report);
        }

        [HttpPost]
        [AllowAnonymous]
        public ActionResult Test(VerifyPluginModel results)
        {
            if (ModelState.IsValid)
            {
            }

            return new JsonResult() { Data = new { success = ModelState.IsValid } };
        }


        [AllowAnonymous]
        public ActionResult Index(string id)
        {
            ViewBag.Message = "Modify this template to jump-start your ASP.NET MVC application.";

            if (id == "Awesome")
                ViewBag.Message = "I'm so Awesome!";

            return View();
        }

        public ActionResult About()
        {
            ViewBag.Message = "Your app description page.";

            return View();
        }

        [AllowAnonymous]
        public ActionResult Contact()
        {
            ViewBag.Message = "Your contact page.";

            return View();
        }
    }
}
