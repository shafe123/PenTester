using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;
using System.Web.Routing;
using WebMatrix.WebData;

namespace PenTester.Utilities
{
    public class AuthorizeCookieAttribute : ActionFilterAttribute
    {
        public override void OnActionExecuting(ActionExecutingContext filterContext)
        {
            if (!filterContext.ActionDescriptor.IsDefined(typeof(AllowAnonymousAttribute), true)
                || WebSecurity.IsAuthenticated)
            {
                HttpCookie auth = filterContext.HttpContext.Request.Cookies.Get("PenTester");
                if (auth != null)
                {
                    DateTime time = DateTime.Parse(auth.Values["expirDate"].ToString());
                    string username = auth.Values["username"].ToString();
                    string session = auth.Values["sessionID"].ToString();
                    if (username == WebSecurity.CurrentUserName
                        //&& session == filterContext.HttpContext.Session.SessionID
                        && time >= DateTime.Now)
                    {
                        HttpCookie renew = auth;
                        auth.Values["expirDate"] = DateTime.Now.AddMinutes(10).ToString();
                        renew.Expires = DateTime.Now.AddMinutes(10);
                        filterContext.HttpContext.Response.SetCookie(renew);

                        return;
                    }
                }

                //throw new SecurityException("You can not access this page");
                HttpCookie deauth = new HttpCookie("PenTester");
                //auth.Expires = DateTime.Now.AddMinutes(-1);

                filterContext.HttpContext.Response.SetCookie(deauth);

                WebSecurity.Logout();
                filterContext.HttpContext.Session.Abandon();

                RouteValueDictionary redirectTargetDictionary = new RouteValueDictionary();
                redirectTargetDictionary.Add("action", "Login");
                redirectTargetDictionary.Add("controller", "Account");
                filterContext.Result = new RedirectToRouteResult(redirectTargetDictionary);
            }
        }
    }
}